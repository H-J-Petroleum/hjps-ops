# Foundations Implementation Methods – Comparison

This reference captures the different coding and data-handling approaches used across Foundations (workflows, CMS modules, properties/custom objects). Use it to identify consolidation opportunities.

> **Toolbox Link**: Consolidation work should feed directly into the shared helper library and governance rules outlined in [docs/standards/toolbox.md](../../../../docs/standards/toolbox.md) so HubSpot, Frappe, and future services stay aligned.

## 1. Workflow Automation Patterns

| Method | Where Used | What It Does | Strengths | Risks / Pain Points | References |
| --- | --- | --- | --- | --- | --- |
| **Node custom code in workflows** | WF-01 `Update Recruiting Deal`, WF-03 `Update Sales Deal & Create Custom Project Object`, WF-09 `Scope of Work – Approval` | Uses HubSpot Node SDK to pull associations/properties and patch records; constructs HTML buttons and links (e.g., scope creation, approval notes). | Fine-grained control; can orchestrate multi-object updates in one action. | Hard-coded HTML/URLs; scattered environment secrets; no shared utility layer; debugging tied to workflow logs. | `data/raw/workflows/v4-flow-567275018.json`, `v4-flow-567293814.json`, `v4-flow-567402589.json` |
| **Property-based workflow actions** | WF-04/05 (well associations), standard deal property updates | Uses native property setters or association actions without custom code. | Simple to maintain; visible in workflow UI. | Limited logic; relies on consistent property naming; difficult to reuse beyond simple updates. | `analysis/timesheet_process/phases/01-foundation/company_associations/workflows/workflow-sequence.md` |
| **HubSpot re-enrollment and branch logic** | WF-03, WF-04/05 | LIST_BRANCH + re-enrollment triggers monitor association gaps. | Prevents bad data from progressing; gives clear failure notes. | Branching scattered across workflows; no shared documentation for conditions. | `data/raw/workflows/v4-flow-567293814.json` |

### Observations
- Custom code blocks now generate consultant URL, scope URL, and well URL independently—no shared script.
- Approval workflow (WF-09) patches both contact and custom object records, but relies on comma-separated property arrays (`sof_*`).
- Error messaging and remediation instructions live inside workflow notes; there is no shared library.

## 2. CMS Module Patterns

| Method | Where Used | What It Does | Strengths | Risks / Pain Points | References |
| --- | --- | --- | --- | --- | --- |
| **Inline JavaScript manipulating `window.location`** | `hjp-consultant-notified.module`, `hjp-new-timesheet-entry-01-FIRST-KEEP IT.module` | Redirects users to the next step with query parameters. | Fast iteration; no external build step. | Mixed casing/parameter names; hard to test; duplication across modules. | `data/raw/hubspot-cms-assets/Timesheets-Theme/modules/hjp-consultant-notified.module/module.html` |
| **Repeated scope authoring modules** | `hjp-prepare-consultants-start/01/02/overview` | Multi-step scope builder storing values in hidden fields/HubL variables. | Familiar structure for content editors. | No shared component library; validation logic split between JS and forms; pricing arrays concatenated manually. | `data/raw/hubspot-cms-assets/Timesheets-Theme/modules/hjp-prepare-consultants-02.module/module.html` |
| **Approval landing pages** | `hjp-approve-scope-of-work.module`, `hjp-approve-scope-of-work-02.module` | Renders approval request details and posts to HubSpot forms. | Keeps approval flow inside CMS. | Large modules (600–900 lines) with inline CSS/JS; difficult to version; no shared service layer. | `data/raw/hubspot-cms-assets/Timesheets-Theme/modules/hjp-approve-scope-of-work.module/module.html` |

### Observations
- Scope and approval modules use custom HTML buttons generated by workflows; same structure repeated across pages.
- Form validation is minimal; relies on workflows catching missing arrays.
- No central script/API wrapper for the CMS modules; each module builds URLs manually.

## 3. Property & Data Storage Patterns

| Data Type | Storage Pattern | Pros | Cons | References |
| --- | --- | --- | --- | --- |
| HTML buttons in deal properties | `assign_consultant_to_a_new_sales_deal`, `scope_of_work_and_pricing`, `create_associate_well` | Immediate use in HubSpot UI; allows quick access links. | HTML embedded in properties is brittle; difficult to internationalize; security concerns for inline HTML. | `analysis/timesheet_process/phases/01-foundation/project_configuration/properties/property-mapping.json` |
| Comma-separated arrays on contacts | `sof_record_ids_array`, `sof_approved_array`, `sof_consultant_hourly_prices`, etc. | Simplifies storing multiple values without custom objects. | Parsing logic duplicated in workflows; no structural guarantees; hard to audit. | `analysis/timesheet_process/phases/01-foundation/scope_management/properties/property-mapping.json` |
| Custom object pricing fields | `2-26103040` (HJ Consultants) pricing columns | Centralized per-consultant pricing data. | Workflow-coded updates; no shared API wrapper; sparse documentation. | `analysis/timesheet_process/phases/01-foundation/scope_management/properties/property-mapping.json` |
| Association labels | Customer/Operator/Approver/Consultant labels in WF-03 & WF-04/05 | Clear semantics for workflows. | Labels must be manually coordinated across teams; no governance tool. | `data/raw/workflows/v4-flow-567293814.json`, `v4-flow-567358311.json` |

## 4. Comparison Summary

| Area | Current Method | Alternative Direction |
| --- | --- | --- |
| URL generation | Workflow custom code writes HTML buttons | Centralize in a service (serverless function) returning signed URLs; workflows call the service |
| Scope data capture | CMS modules + contact arrays | Consider dedicated custom object per scope submission or JSON property instead of comma-separated lists |
| Approval routing | Workflow custom code sends notes/emails | Evaluate serverless/CRM extension for richer approval UI and status tracking |
| Property storage | HTML strings in deal properties | Shift to CRM cards or HubDB/CRM extensions for better maintainability |

## 5. Next Steps
- **Inventory gaps:** List all modules/forms tied to scope and approvals to understand overlap (see assets file).
- **Paved road proposal:** Draft a target pattern (e.g., serverless API + shared library) for URL and approval generation.
- **Migration plan:** Prioritize conversions starting with scope creation (highest number of custom code paths).

Use this sheet as a baseline when evaluating refactors or AI agent improvements.

---

## Detailed Asset Inventory

### Workflows

| ID | Name | Object | Pattern | Key Inputs | Outputs / Side Effects | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| 567275018 | 01. Update Recruiting Deal | Deal (Recruiting pipeline) | Node custom code (Action 1/3) | Deal ID, owner, consultant association (`which_discipline_`, contact properties) | Writes consultant metadata, `assign_consultant_to_a_new_sales_deal`, `link_for_consultant`, `scope_of_work_and_pricing`; sets helper flags (`test`, `test_link`) | Generates HTML buttons directly inside deal properties; clears values when deal leaves stage |
| 567293814 | 03. Update Sales Deal & Create Custom Project Object | Deal (Sales pipeline) | Node custom code with association checks + property writes | Deal associations (Customer, Operator, Approver, Primary), MSA terms, deal owner | Validates associations, toggles `missing_important_info`, writes customer/operator/owner fields, populates well URL | Heavy branching via LIST_BRANCH; writes remediation notes (`deal_error_note_id`) |
| 567363849 | 06. Associate Consultant to a New Sales Deal | Deal | Node custom code triggered by form submission (`consultant assignment`) | Deal ID, consultant contact fields submitted via form | Creates deal ↔ consultant association (type 4), syncs consultant full name/title | Relies on hidden fields from CMS forms; raises conflicts if consultant equals approver |
| 567358311 | 04. Associate Created Well to Sales Deal | HJ Wells → Deal/Company | Native association actions | `hj_well_operator_id`, `hj_well_deal_id` on HJ Wells | Creates association type 126 (company↔well) and 128 (deal↔well) | Depends on WF-03 populating `create_associate_well` link and CMS form IDs |
| 567358566 | 05. Associate Existing Wells to Sales Deal | Contact → Deal | Native association loop (custom code not present) | Contact arrays (`associate_existing_wells_ids_array`, `associate_existing_wells_sales_deal_id`) | Associates existing wells to target deal (type 128) | No array validation; relies on CMS form to provide IDs |
| 567402589 | 09. Scope of Work – Approval | Contact | Node custom code | Scope approval form fields (`sof_*` arrays, `sof_sales_deal_id`) | Updates HJ Consultants custom object pricing, creates deal note, patches approver contact with view button | Works with comma-separated arrays; constructs approval messaging in HTML |

### CMS Modules & Pages

| Module / Page | Purpose | Key Techniques | Dependencies |
| --- | --- | --- | --- |
| `hjp-prepare-consultants-start.module` | Entry point for scope authoring | Inline HubL + JS populating hidden fields | Uses `scope_of_work_and_pricing` parameters |
| `hjp-prepare-consultants-01.module` | Consultant readiness details | HubL form rendering, minimal JS | Consumes consultant context from query params |
| `hjp-prepare-consultants-02.module` | Pricing matrix capture | Extensive inline JS building arrays (`sof_*`) | Writes data to hidden inputs consumed by approval form |
| `hjp-prepare-consultants-overview.module` | Review + submission step | HubL, inline JS for summary | Submits Scope Request form |
| `hjp-approve-scope-of-work.module` / `-02` | Approval experience (step 01/02) | Large HTML/JS blocks; dynamic button rendering | Expect specific URL parameters (`approval_request_id`, etc.) |
| `hjp-assign-consultant-to-new-deal-01/02/03` | Consultant intake wizard | Inline JS for navigation; uses `assign_consultant_to_a_new_sales_deal` | WF-01 button output |
| `hjp-create-associate-well.module`, `hjp-created-well.module` | Well creation flow | Form-driven; limited JS | `create_associate_well` URL |

### Forms

| Form Name | Object | Purpose | Notes |
| --- | --- | --- | --- |
| Consultant Assignment Form (`f1784acd-d74d-441e-b5e5-c0c4fbbf2f5e`) | Contact | Collects consultant/deal IDs; triggers WF-06 | Hidden fields must stay aligned with workflow expectations |
| Scope of Work – Request for Approval | Contact | Submits compiled scope payload | Populates `sof_*` arrays on contact record |
| Scope of Work – Approval | Contact | Captures approval decision and comment | Triggers WF-09; requires pricing arrays to be present |
| Scope of Work – Update/Delete | Contact | Maintains existing scope entries | Used less frequently; no workflow coverage yet |
| Create Well Form (`b682c714-e395-4677-bbfb-1a32fad5f04b`) | Custom object (HJ Wells) | Kicks off WF-04 for new wells | Requires operator/deal IDs |
| Associate Existing Wells Form (`3876c3f0-6363-4958-a3be-500a64bd6431`) | Contact | Provides well ID arrays for WF-05 | Needs validation to prevent empty submissions |

### Key Properties / Data Stores

| Object | Property Pattern | Usage | Notes |
| --- | --- | --- | --- |
| Deal | HTML buttons (`assign_consultant_to_a_new_sales_deal`, `scope_of_work_and_pricing`, `create_associate_well`) | Quick links in CRM UI | Generated via workflows; brittle HTML strings |
| Deal | Status flags (`missing_important_info`, `deal_error_note_id`) | Validation + remediation messaging | Controlled by WF-03 |
| Contact | `sof_*` arrays (pricing/status) | Temporary storage for scope approvals | Managed by CMS forms and WF-09; comma-separated values |
| HJ Consultants (Custom object `2-26103040`) | Pricing fields (`hourly_role_price`, etc.) | Persistent pricing + approval results | Updated via WF-09 custom code |
| Company | `hj_terms`, `hj_taxable` | Billing data pulled into projects | Fetched in WF-03 |

### URL Patterns

| Purpose | Pattern | Source |
| --- | --- | --- |
| Consultant assignment | `https://app.hubspot.com/l/consultant-assignment?dealId={deal_id}&consultantId={consultant_vid}` | WF-01 |
| Consultant portal | `https://portal.hjpetroleum.com/timesheets/{token}` | WF-01 |
| Scope creation | `https://hjpetro-1230608.hs-sites.com/prepare-consultants-start?consultant_deal_id={deal_id}&consultant_unique_id={consultant_id}&consultant_name={encoded_name}&consultant_email={email}` | WF-01 |
| Scope approval view | `https://hjpetro-1230608.hs-sites.com/prepare-consultants-overview?consultant_unique_id={id}&consultant_name={name}&project_id={project}&approval_request_id={request}&owner_email={email}` | WF-09 |
| Well creation | `https://portal.hjpetroleum.com/wells/new?dealId={deal_id}` | WF-03 |

These tables should be expanded whenever new assets are added or existing ones are refactored.

