# URL Parameter Sources & Flow
*Complete documentation of URL parameter origins and flow through the approval process*

## üéØ **Overview**

This document traces all URL parameters from their original sources through the approval process to resolve duplication confusion and ensure proper data flow.

## üìä **Parameter Flow Map**

```
Project Selection ‚Üí Timesheet Management ‚Üí Approval Request ‚Üí Approval Interface
```

## üîÑ **URL Parameter Inventory**

### **1. Consultant Information Parameters**

| Parameter | Source Module | Source Property | Target Module | Purpose |
|-----------|---------------|-----------------|---------------|---------|
| `consultant_id` | Project Selection | `request.query_dict.consultant_id` | Timesheet Management | Encrypted consultant ID |
| `consultant_email` | Project Selection | `request.query_dict.consultant_email` | Timesheet Management | Consultant email for delegation |
| `consultant_name` | Project Selection | `request.query_dict.consultant_name` | Timesheet Management | Consultant display name |

**Source:** Project selection interface (landing page)
**Flow:** Project Selection ‚Üí Timesheet Management ‚Üí Approval Request
**Critical:** Required for consultant identification and delegation

### **2. Project Information Parameters**

| Parameter | Source Module | Source Property | Target Module | Purpose |
|-----------|---------------|-----------------|---------------|---------|
| `project_id` | Project Selection | `request.query_dict.project_id` | Timesheet Management | Project reference |
| `project_name` | Project Selection | `hj_projects.results[0].hj_project_name` | Approval Request | Project display name |

**Source:** Project selection interface
**Flow:** Project Selection ‚Üí Timesheet Management ‚Üí Approval Request ‚Üí HJ Approvals
**Critical:** Required for project association and approver lookup

### **3. Delegation Parameters**

| Parameter | Source Module | Source Property | Target Module | Purpose |
|-----------|---------------|-----------------|---------------|---------|
| `timesheet_contact` | Timesheet Management | `submit_as_pseudo_contact` | Approval Request | Delegation flag |
| `email_to_submit` | Timesheet Management | `submit_email` | Approval Request | Delegation email |

**Source:** Timesheet Management module (user selection)
**Flow:** Timesheet Management ‚Üí Approval Request ‚Üí Contact Properties
**Critical:** Determines who receives approval notifications

### **4. Approval Interface Parameters**

| Parameter | Source Module | Source Property | Target Module | Purpose |
|-----------|---------------|-----------------|---------------|---------|
| `approval_id` | Workflow 13 | `{{ approval.hs_object_id }}` | Approval Interface | Approval record ID |
| `approver_email` | Workflow 13 | `{{ approval.approver_email }}` | Approval Interface | Approver email |
| `approver_name` | Workflow 13 | `{{ approval.approver_full_name }}` | Approval Interface | Approver name |

**Source:** Workflow 13 (Consultant Approval Request)
**Flow:** Workflow 13 ‚Üí Approval Interface ‚Üí Approval Response
**Critical:** Required for approval interface functionality

## üîÑ **Parameter Flow by Process Stage**

### **Stage 1: Project Selection**
```javascript
// Parameters generated by project selection interface
{
  consultant_id: "encrypted_consultant_id",
  consultant_email: "consultant@example.com", 
  consultant_name: "John Doe",
  project_id: "123456789"
}
```

### **Stage 2: Timesheet Management**
```javascript
// Parameters passed from project selection + delegation logic
{
  consultant_id: "encrypted_consultant_id",
  consultant_email: "consultant@example.com",
  consultant_name: "John Doe", 
  project_id: "123456789",
  timesheet_contact: "delegated_contact_id",
  email_to_submit: "delegated@example.com"
}
```

### **Stage 3: Approval Request**
```javascript
// Parameters used to populate form fields
{
  consultant_id: "encrypted_consultant_id",
  consultant_email: "consultant@example.com",
  consultant_name: "John Doe",
  project_id: "123456789", 
  timesheet_contact: "delegated_contact_id",
  email_to_submit: "delegated@example.com",
  // Plus form field values populated from these parameters
}
```

### **Stage 4: Approval Interface**
```javascript
// Parameters generated by workflow for approval interface
{
  approval_id: "approval_record_id",
  project_id: "123456789",
  approver_email: "approver@example.com",
  approver_name: "Approver Name"
}
```

## üö® **Critical Dependencies**

### **1. Parameter Chain Integrity**
- **Issue:** Missing parameters break the entire flow
- **Solution:** Validate all required parameters at each stage
- **Impact:** High - process fails without complete parameter chain

### **2. Delegation Logic**
- **Issue:** Complex delegation parameter handling
- **Solution:** Clear delegation flag logic and email routing
- **Impact:** Medium - affects notification delivery

### **3. Encrypted Parameters**
- **Issue:** `consultant_id` is encrypted and must be handled carefully
- **Solution:** Use HubSpot's built-in encryption/decryption
- **Impact:** High - security and functionality dependent

## üîß **Parameter Validation Rules**

### **Required Parameters (All Stages)**
- `consultant_id` - Must be valid encrypted ID
- `project_id` - Must be valid project ID
- `consultant_email` - Must be valid email format

### **Delegation Parameters (When Applicable)**
- `timesheet_contact` - Must be valid contact ID if delegation
- `email_to_submit` - Must be valid email if delegation

### **Approval Parameters (Approval Stage)**
- `approval_id` - Must be valid approval record ID
- `approver_email` - Must be valid email format
- `approver_name` - Must be non-empty string

## üìã **Debugging Checklist**

### **Parameter Flow Issues**
- [ ] Check parameter passing between modules
- [ ] Verify parameter sources are correct
- [ ] Test delegation parameter logic
- [ ] Validate encrypted parameter handling

### **Missing Parameter Issues**
- [ ] Identify which stage parameters are missing
- [ ] Check parameter source modules
- [ ] Verify parameter validation logic
- [ ] Test parameter fallback mechanisms

### **Parameter Format Issues**
- [ ] Validate parameter data types
- [ ] Check parameter encoding/decoding
- [ ] Test parameter length limits
- [ ] Verify parameter special characters

## üõ†Ô∏è **Common Fixes**

### **Fix 1: Missing Project ID**
```javascript
// Add validation in timesheet management module
if (!request.query_dict.project_id) {
  // Redirect to project selection
  window.location.href = '/project-selection';
}
```

### **Fix 2: Invalid Delegation Email**
```javascript
// Validate delegation email before form submission
if (delegation_enabled && !isValidEmail(email_to_submit)) {
  showError('Invalid delegation email address');
  return false;
}
```

### **Fix 3: Missing Approval ID**
```javascript
// Check approval ID in approval interface
if (!request.query_dict.approval_id) {
  showError('Invalid approval link');
  return;
}
```

---

*This documentation resolves the URL parameter duplication confusion by clearly mapping each parameter to its source and flow through the process.*
